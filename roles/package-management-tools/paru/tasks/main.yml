---
# tasks file for paru
# TODO: add alias like 'pkg update', 'pkg upgrade', 'pkg install', 'pkg install-alternative'?
- name: Check that the Paru already installed
  ansible.builtin.stat:
    path: /usr/bin/paru
  register: paru_stat_result

- name: Get source from AUR
  become: true
  ansible.builtin.shell: rm -rf /tmp/paru && git clone https://aur.archlinux.org/paru.git
  args:
    chdir: /tmp
    executable: /usr/bin/bash
  when: not paru_stat_result.stat.exists
  register: paru_get_result
  changed_when: paru_get_result.rc == 0

- name: Recursively change ownership of the source directory
  become: true
  ansible.builtin.file:
    path: /tmp/paru
    state: directory
    recurse: true
    owner: '{{ ansible_user_id }}'
    group: '{{ ansible_user_id }}'
  when: paru_get_result.rc == 0

- name: Make and install
  ansible.builtin.shell: makepkg -si --noconfirm
  args:
    chdir: /tmp/paru
    executable: /bin/bash
  register: paru_install_result
  when: paru_get_result.rc == 0
  changed_when: paru_install_result.rc == 0

- name: Update AUR packages cache and upgrade packages
  kewlfft.aur.aur:
    use: paru
    update_cache: true
    upgrade: true
  when: paru_stat_result.stat.exists
